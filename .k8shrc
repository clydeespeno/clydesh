export KUBE_NAMESPACE="default"
[ -f "$HOME/.kubenamespace" ] && export KUBE_NAMESPACE=`cat $HOME/.kubenamespace`

export KUBE_PORT_ALIAS_FILE=${KUBE_PORT_ALIAS_FILE:-$HOME/.kubeportaliases}

function k-ns() {
  if [ -n "$1" ]; then
    echo "$1" > ~/.kubenamespace
    echo "switched to namespace \"$1\""
    export KUBE_NAMESPACE="$1"
  else
    cat ~/.kubenamespace
  fi
}

function kn() {
  kubectl -n `cat ~/.kubenamespace` $@
}

function k-ex() {
  kn exec -it $@
}

function k-bash() {
  k-ex $@ bash
}

function k-sh() {
  k-ex $@ sh
}

function k-log() {
  kn logs $@
}

function k-pod() {
  kn get pods $@
}

function k-dpod() {
  kn describe pod $@
}

function k-xpod() {
  kn delete pod $@
}

function _parseport() {
  parsed=$(cat ${KUBE_PORT_ALIAS_FILE} | grep -w $1 | head -1 | awk '{print $2}')
  if [ -z "$parsed" ]; then
    [[ "$1" == *":"* ]] && parsed="$1" || parsed="$1:$1"
  fi
  echo $parsed
}

function k-fwd() {
  port=$(_parseport $2)
  kn port-forward $1 $port
}

function k-dep() {
  kn get deploy $@
}

function k-xdep() {
  kn delete deploy $@
}

function k-scale-dep() {
  kn scale deployment/$1 --replicas=$2
}

function k-xdep-scale() {
  k-scale-dep $1 0
  echo "deployment $1 is scaled down to 0. Press ENTER to delete deployment"
  read
  k-xdep $1
}

function k-ddep() {
  kn describe deploy $@
}

function k-ser() {
  kn get service $@
}

function k-dser() {
  kn describe service $@
}

function k-sec() {
  kn get secret $@
}

function k-dsec() {
  kn describe secret $@
}

function k-watch() {
  service=${1:-"."}
  watch -n 1 "kubectl -n $KUBE_NAMESPACE get pods ${@:2} | grep \"$service\""
}

function k-sec64() {
  k-sec $1 -o json | jq -r ".data[\"$2\"]" | base64 --decode
}

function k-cluster() {
  local context=$1
  if [ -z "$context" ]; then
    kubectl config current-context
  else
    kubectl config use-context $context
  fi
}

function _k_ns_completion() {
  local namespaces=`kubectl get namespaces | tail -n +2 | awk '{print $1;}'`
  COMPREPLY=($(compgen -W "$namespaces"))
  return 0
}

function _k_pod_completion() {
  local services=`kn get pods | tail -n +2 | awk '{print $1;}'`
  COMPREPLY=($(compgen -W "$services"))
  return 0
}

function _k_deploy_completion() {
  local deploys=`kn get deploy | tail -n +2 | awk '{print $1;}'`
  COMPREPLY=($(compgen -W "$deploys"))
  return 0
}

function _k_service_completion() {
  local servs=`kn get service | tail -n +2 | awk '{print $1;}'`
  COMPREPLY=($(compgen -W "$servs"))
  return 0
}

function _k_secret_completion() {
  local secrets=`kn get secret | tail -n +2 | awk '{print $1;}'`
  COMPREPLY=($(compgen -W "$secrets"))
  return 0
}

function _k_cluster_completion() {
  local clusters=`kubectl config view -o json | jq -r '.contexts[].name'`
  COMPREPLY=($(compgen -W "$clusters"))
  return 0
}

function _k_fwd_completion() {
  local reply=""
  if [ ${COMP_CWORD} == "1" ]; then
    reply=$(kn get pods | tail -n +2 | awk '{print $1;}')
  else if [ ${COMP_CWORD} == "2" ]
    reply=$(cat $KUBE_PORT_ALIAS_FILE | awk '{print $1}')
  fi
  COMPREPLY=($(compgen -W "$reply"))
  return 0
}

complete -F _k_ns_completion k-ns
complete -F _k_pod_completion k-bash k-sh k-ex k-log k-pod k-dpod k-xpod
complete -F _k_deploy_completion k-dep k-ddep k-xdep k-scale-dep k-xdep-scale
complete -F _k_service_completion k-ser k-dser
complete -F _k_secret_completion k-sec k-dsec k-sec64
complete -F _k_cluster_completion k-cluster
complete -F _k_fwd_completion k-fwd
