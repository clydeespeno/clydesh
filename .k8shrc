export KUBE_NAMESPACE="default"
[ -f "$HOME/.kubenamespace" ] && export KUBE_NAMESPACE=`cat $HOME/.kubenamespace`

function k-ns() {
  if [ -n "$1" ]; then
    echo "$1" > ~/.kubenamespace
    export KUBE_NAMESPACE="$1"
  else
    cat ~/.kubenamespace
  fi
}

function kn() {
  kubectl -n `cat ~/.kubenamespace` $@
}

function k-ex() {
  kn exec -it $@
}

function k-bash() {
  k-ex $@ bash
}

function k-sh() {
  k-ex $@ sh
}

function k-log() {
  kn logs $@
}

function k-pod() {
  kn get pods $@
}

function k-dpod() {
  kn describe pod $@
}

function k-xpod() {
  kn delete pod $@  
}

function k-fwd() {
  kn port-forward $@
}

function k-dep() {
  kn get deploy $@
}

function k-xdep() {
  kn delete deploy $@
}

function k-ddep() {
  kn describe deploy $@
}

function k-ser() {
  kn get service $@
}

function k-dser() {
  kn describe service $@
}

function k-sec() {
  kn get secret $@
}

function k-dsec() {
  kn describe secret $@
}

function k-watch() {
  watch -n 1 "kubectl -n $KUBE_NAMESPACE get pods ${@:2} | grep $1"
}

function k-sec64() {
  k-sec $1 -o json | jq -r ".data[\"$2\"]" | base64 --decode
}

function k-cluster() {
  local context=$1
  if [ -z "$context" ]; then
    kubectl config current-context
  else
    kubectl config use-context $context
  fi
}

function _k_ns_completion() {
  local namespaces=`kubectl get namespaces | tail -n +2 | awk '{print $1;}'`
  COMPREPLY=($(compgen -W "$namespaces"))
  return 0
}

function _k_pod_completion() {
  local services=`kn get pods | tail -n +2 | awk '{print $1;}'`
  COMPREPLY=($(compgen -W "$services"))
  return 0
}

function _k_deploy_completion() {
  local deploys=`kn get deploy | tail -n +2 | awk '{print $1;}'`
  COMPREPLY=($(compgen -W "$deploys"))
  return 0
}

function _k_service_completion() {
  local servs=`kn get service | tail -n +2 | awk '{print $1;}'`
  COMPREPLY=($(compgen -W "$servs"))
  return 0
}

function _k_secret_completion() {
  local secrets=`kn get secret | tail -n +2 | awk '{print $1;}'`
  COMPREPLY=($(compgen -W "$secrets"))
  return 0
}

function _k_cluster_completion() {
  local clusters=`kubectl config view -o json | jq -r '.contexts[].name'`
  COMPREPLY=($(compgen -W "$clusters"))
  return 0
}

complete -F _k_ns_completion k-ns
complete -F _k_pod_completion k-bash k-sh k-ex k-log k-pod k-dpod k-xpod k-fwd
complete -F _k_deploy_completion k-dep k-ddep k-xdep
complete -F _k_service_completion k-ser k-dser
complete -F _k_secret_completion k-sec k-dsec k-sec64
complete -F _k_cluster_completion k-cluster
complete -F __start_kubectl k kn
